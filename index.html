<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>接球计数器 Pro - 权限分离版</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.js" crossorigin="anonymous"></script>
    <style>
        :root { --primary: #007aff; --success: #34c759; --bg: #000; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; height: 100vh; }
        
        /* 视频区域初始高度为0，仅在开启视觉时展开 */
        #video-container { position: relative; width: 100%; height: 0; background: #111; transition: height 0.5s ease; overflow: hidden; }
        #webcam { width: 100%; height: 100%; object-fit: cover; transform: rotateY(180deg); }
        #canvas-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: rotateY(180deg); pointer-events: none; }

        .header { text-align: center; padding: 20px 0; }
        #counter { font-size: 120px; font-weight: 800; color: var(--success); margin: 0; }
        #log { font-size: 14px; color: #888; margin-top: 10px; height: 20px; }
        
        .panel { background: #1c1c1e; width: 90%; margin: 10px auto; padding: 20px; border-radius: 20px; flex-grow: 1; }
        .switch-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* 基础开关样式 */
        input[type="checkbox"] { width: 44px; height: 24px; appearance: none; background: #333; border-radius: 20px; position: relative; }
        input[type="checkbox"]:checked { background: var(--primary); }
        input[type="checkbox"]:before { content: ''; position: absolute; width: 20px; height: 20px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: 0.2s; }
        input[type="checkbox"]:checked:before { left: 22px; }

        .controls { padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        button { width: 100%; height: 55px; border-radius: 15px; border: none; font-size: 18px; font-weight: 600; }
        #mainBtn { background: var(--primary); color: white; }
    </style>
</head>
<body>

    <div id="video-container">
        <video id="webcam" autoplay playsinline muted></video>
        <canvas id="canvas-overlay"></canvas>
    </div>

    <div class="header">
        <div id="counter">0</div>
        <div id="log">准备就绪</div>
    </div>

    <div class="panel">
        <div class="switch-row">
            <span>开启视觉校验 (需摄像头)</span>
            <input type="checkbox" id="visionToggle">
        </div>
        <div class="switch-row">
            <span>人物区域锁定 (ROI)</span>
            <input type="checkbox" id="roiToggle">
        </div>
        
        <div style="margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: #888;">
                <span>声音灵敏度</span><span id="threshVal">0.35</span>
            </div>
            <input type="range" id="threshSlider" style="width:100%" min="0.05" max="0.8" step="0.01" value="0.35">
        </div>
    </div>

    <div class="controls">
        <button id="mainBtn">启动音频监测</button>
        <button style="background:#2c2c2e; color:#ccc;" onclick="location.reload()">重置</button>
    </div>

<script type="module">
    const vision = window.tasksVision;
    let poseLandmarker, audioCtx, analyser, dataArray;
    let isAudioRunning = false, isVisionActive = false;
    let count = 0, lastEventTime = 0, personInROI = true;

    // --- 1. 音频启动逻辑 ---
    document.getElementById('mainBtn').onclick = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioCtx.createMediaStreamSource(stream);
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 512;
            source.connect(analyser);
            dataArray = new Float32Array(analyser.fftSize);

            isAudioRunning = true;
            document.getElementById('mainBtn').style.display = 'none';
            document.getElementById('log').innerText = "音频监测中...";
            requestAnimationFrame(audioLoop);
        } catch (err) {
            alert("请允许麦克风权限以开始计数");
        }
    };

    // --- 2. 视觉权限按需获取 ---
    document.getElementById('visionToggle').onchange = async (e) => {
        if (e.target.checked) {
            try {
                document.getElementById('log').innerText = "正在请求摄像头...";
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                document.getElementById('webcam').srcObject = stream;
                document.getElementById('video-container').style.height = "30vh";
                
                // 加载 MediaPipe 模型
                if (!poseLandmarker) {
                    const filesetResolver = await vision.FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
                    poseLandmarker = await vision.PoseLandmarker.createFromOptions(filesetResolver, {
                        baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task`, delegate: "GPU" },
                        runningMode: "VIDEO", numPoses: 1
                    });
                }
                isVisionActive = true;
                document.getElementById('log').innerText = "声影双重监测已激活";
            } catch (err) {
                e.target.checked = false;
                alert("无法获取摄像头权限");
            }
        } else {
            isVisionActive = false;
            document.getElementById('video-container').style.height = "0";
            document.getElementById('log').innerText = "切换回纯音频模式";
        }
    };

    // --- 3. 混合检测循环 ---
    function audioLoop() {
        if (!isAudioRunning) return;

        // 音频分析
        analyser.getFloatTimeDomainData(dataArray);
        let maxAmp = 0;
        for (let i = 0; i < dataArray.length; i++) maxAmp = Math.max(maxAmp, Math.abs(dataArray[i]));

        const now = Date.now();
        const threshold = parseFloat(document.getElementById('threshSlider').value);
        document.getElementById('threshVal').innerText = threshold;

        if (maxAmp > threshold && (now - lastEventTime > 700)) {
            // 如果开启了视觉，进行二次校验
            let passVision = true;
            if (isVisionActive && poseLandmarker) {
                const results = poseLandmarker.detectForVideo(document.getElementById('webcam'), performance.now());
                passVision = checkPose(results);
            }

            if (passVision) {
                count++;
                lastEventTime = now;
                document.getElementById('counter').innerText = count;
                if (navigator.vibrate) navigator.vibrate(50);
            }
        }
        requestAnimationFrame(audioLoop);
    }

    function checkPose(results) {
        if (!results || results.landmarks.length === 0) return true; // 没拍到人时回退到纯音频
        const lm = results.landmarks[0];
        
        // ROI 判定：人在画面横向 20%-80% 之间
        if (document.getElementById('roiToggle').checked) {
            const centerX = (lm[23].x + lm[24].x) / 2;
            if (centerX < 0.2 || centerX > 0.8) return false;
        }
        
        // 视觉加速度补偿：接球时双手应靠近
        const dist = Math.sqrt(Math.pow(lm[15].x - lm[16].x, 2) + Math.pow(lm[15].y - lm[16].y, 2));
        return dist < 0.25; 
    }
</script>
</body>
</html>
