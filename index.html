<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>接球计数器 Pro - 科幻视觉版</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.js" crossorigin="anonymous"></script>
    <style>
        :root { --primary: #007aff; --success: #00ff41; --danger: #ff3b30; --neon: #00f2ff; }
        body { margin: 0; background: #000; color: #fff; font-family: 'Courier New', Courier, monospace; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        
        /* 科幻频谱画布 */
        #visualizer { position: absolute; top: 0; width: 100%; height: 150px; z-index: 1; opacity: 0.8; pointer-events: none; }

        /* 视频容器：默认隐藏，开启后平滑展开 */
        #video-container { position: relative; width: 100%; height: 0; background: #050505; transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; z-index: 2; border-bottom: 1px solid var(--neon); }
        #webcam { width: 100%; height: 100%; object-fit: cover; transform: rotateY(180deg); filter: brightness(1.2) contrast(1.1); }
        #canvas-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: rotateY(180deg); pointer-events: none; }

        .header { margin-top: 60px; text-align: center; z-index: 3; }
        #counter { font-size: 140px; font-weight: 900; margin: 5px 0; color: var(--success); text-shadow: 0 0 20px var(--success); font-family: sans-serif; }
        
        .panel { background: rgba(28, 28, 30, 0.9); width: 88%; padding: 20px; border-radius: 24px; box-sizing: border-box; z-index: 3; border: 1px solid #333; backdrop-filter: blur(10px); }
        .setting-item { margin-bottom: 20px; }
        .setting-label { display: flex; justify-content: space-between; margin-bottom: 10px; color: var(--neon); font-size: 13px; letter-spacing: 1px; }
        
        /* 苹果风格开关 */
        .switch-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        input[type="checkbox"] { width: 50px; height: 26px; appearance: none; background: #333; border-radius: 20px; position: relative; transition: .3s; border: 1px solid #444; }
        input[type="checkbox"]:checked { background: var(--primary); box-shadow: 0 0 10px var(--primary); }
        input[type="checkbox"]:before { content: ''; position: absolute; width: 22px; height: 22px; background: white; border-radius: 50%; top: 1px; left: 1px; transition: .3s; }
        input[type="checkbox"]:checked:before { left: 26px; }

        input[type=range] { width: 100%; height: 4px; background: #444; border-radius: 5px; appearance: none; outline: none; }
        input[type=range]::-webkit-slider-thumb { appearance: none; width: 22px; height: 22px; background: #fff; border-radius: 50%; box-shadow: 0 0 10px var(--neon); }

        #log { font-size: 11px; color: #666; height: 20px; text-align: center; margin-top: 10px; text-transform: uppercase; }

        .controls { margin-top: auto; margin-bottom: 40px; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 12px; z-index: 3; }
        button { width: 85%; height: 55px; border-radius: 18px; border: none; font-size: 17px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }
        #startBtn { background: var(--primary); color: white; box-shadow: 0 0 15px var(--primary); }
        .secondary-btns { display: flex; width: 85%; gap: 10px; }
        .secondary-btns button { font-size: 13px; height: 45px; background: #222; color: #888; border: 1px solid #333; }
    </style>
</head>
<body>

    <canvas id="visualizer"></canvas>

    <div id="video-container">
        <video id="webcam" autoplay playsinline muted></video>
        <canvas id="canvas-overlay"></canvas>
    </div>

    <div class="header">
        <div id="counter">0</div>
        <div id="log">SYSTEM READY // WAITING FOR UPLINK</div>
    </div>

    <div class="panel">
        <div class="switch-row">
            <span>VISION OVERLAY (AI)</span>
            <input type="checkbox" id="visionToggle">
        </div>
        
        <div class="setting-item">
            <div class="setting-label">
                <span>THRESHOLD SENSITIVITY</span>
                <span id="threshVal">0.35</span>
            </div>
            <input type="range" id="threshSlider" min="0.05" max="0.8" step="0.01" value="0.35">
        </div>
    </div>

    <div class="controls">
        <button id="startBtn">START MONITORING</button>
        <div class="secondary-btns">
            <button onclick="resetCount()">RESET</button>
            <button onclick="window.location.reload()">RELOAD</button>
        </div>
    </div>

    <script type="module">
        let count = 0, isRunning = false, lastEventTime = 0, isWaitingForDrop = false;
        let audioCtx, analyser, dataArray, highPassFilter, wakeLock = null;
        let poseLandmarker, isVisionActive = false;
        
        const vision = window.tasksVision;
        const webcam = document.getElementById("webcam");
        const canvasElement = document.getElementById("canvas-overlay");
        const canvasCtx = canvasElement.getContext("2d");
        const CONFIG = { dropWindow: 650, minFreq: 3000 };

        // 1. 科幻频谱绘制逻辑
        function drawVisualizer() {
            if (!analyser) return;
            const canvas = document.getElementById('visualizer');
            const ctx = canvas.getContext('2d');
            const w = canvas.width = window.innerWidth;
            const h = canvas.height = 150;
            
            analyser.getFloatTimeDomainData(dataArray);
            ctx.clearRect(0, 0, w, h);
            ctx.beginPath();
            ctx.lineWidth = 2;
            ctx.strokeStyle = isVisionActive ? '#00f2ff' : '#00ff41';
            
            for(let i=0; i<dataArray.length; i++) {
                const x = (i / dataArray.length) * w;
                const y = (dataArray[i] * h * 1.5) + h/2;
                if(i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            }
            ctx.stroke();
            requestAnimationFrame(drawVisualizer);
        }

        // 2. 音频启动 (首选权限)
        document.getElementById('startBtn').onclick = async () => {
            try {
                // Safari 必须在此点击事件内请求权限
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioCtx.createMediaStreamSource(stream);

                highPassFilter = audioCtx.createBiquadFilter();
                highPassFilter.type = "highpass";
                highPassFilter.frequency.value = CONFIG.minFreq;

                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 512;
                source.connect(highPassFilter);
                highPassFilter.connect(analyser);
                dataArray = new Float32Array(analyser.fftSize);

                isRunning = true;
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('log').innerText = "AUDIO LINK ESTABLISHED";
                
                if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen');
                
                requestAnimationFrame(drawVisualizer);
                requestAnimationFrame(audioUpdate);
            } catch (err) {
                alert("SAFARI ERROR: MIC ACCESS DENIED");
            }
        };

        // 3. 视觉启动 (按需权限)
        document.getElementById('visionToggle').onchange = async (e) => {
            if (e.target.checked) {
                try {
                    document.getElementById('log').innerText = "INIT CAMERA LINK...";
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                    webcam.srcObject = stream;
                    document.getElementById('video-container').style.height = "30vh";
                    
                    if (!poseLandmarker) {
                        const filesetResolver = await vision.FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
                        poseLandmarker = await vision.PoseLandmarker.createFromOptions(filesetResolver, {
                            baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task`, delegate: "GPU" },
                            runningMode: "VIDEO", numPoses: 1
                        });
                    }
                    isVisionActive = true;
                    document.getElementById('log').innerText = "DUAL LINK ACTIVE";
                } catch (err) {
                    e.target.checked = false;
                    alert("SAFARI ERROR: CAMERA PERMISSION REJECTED");
                }
            } else {
                isVisionActive = false;
                document.getElementById('video-container').style.height = "0";
            }
        };

        // 4. 核心逻辑循环
        function audioUpdate() {
            if (!isRunning) return;
            analyser.getFloatTimeDomainData(dataArray);
            let maxAmp = 0;
            for (let i = 0; i < dataArray.length; i++) maxAmp = Math.max(maxAmp, Math.abs(dataArray[i]));

            const threshold = parseFloat(document.getElementById('threshSlider').value);
            const now = Date.now();

            if (maxAmp > threshold && (now - lastEventTime > 50)) {
                let visualPass = true;
                if (isVisionActive && poseLandmarker) {
                    const res = poseLandmarker.detectForVideo(webcam, performance.now());
                    if (res.landmarks.length > 0) {
                        const lm = res.landmarks[0];
                        const dist = Math.sqrt(Math.pow(lm[15].x - lm[16].x, 2) + Math.pow(lm[15].y - lm[16].y, 2));
                        if (dist > 0.3) visualPass = false; // 手分太开则判定为噪音
                    }
                }

                if (visualPass) handleImpact(now);
            }
            requestAnimationFrame(audioUpdate);
        }

        function handleImpact(now) {
            if (!isWaitingForDrop) {
                count++;
                isWaitingForDrop = true;
                lastEventTime = now;
                document.getElementById('counter').innerText = count;
                document.getElementById('log').innerText = "IMPACT DETECTED";
                if (navigator.vibrate) navigator.vibrate(50);
                setTimeout(() => { isWaitingForDrop = false; }, CONFIG.dropWindow);
            } else if (now - lastEventTime < CONFIG.dropWindow) {
                count = Math.max(0, count - 1);
                isWaitingForDrop = false;
                document.getElementById('counter').innerText = count;
                document.getElementById('log').innerText = "DROP RECOVERY";
                lastEventTime = now;
            }
        }

        window.resetCount = () => { count = 0; document.getElementById('counter').innerText = 0; };
        document.getElementById('threshSlider').oninput = (e) => { document.getElementById('threshVal').innerText = e.target.value; };
    </script>
</body>
</html>
