<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>接球计数器 </title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.js" crossorigin="anonymous"></script>
    <style>
        :root { --primary: #007aff; --success: #00ff41; --danger: #ff3b30; --neon: #00f2ff; }
        body { margin: 0; background: #000; color: #fff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        
        /* 动态频谱 */
        #visualizer { position: absolute; top: 0; width: 100%; height: 160px; z-index: 1; opacity: 0.6; pointer-events: none; }

        /* 视频容器 */
        #video-container { position: relative; width: 100%; height: 0; background: #050505; transition: height 0.5s ease; overflow: hidden; z-index: 2; border-bottom: 1px solid var(--neon); }
        #webcam { width: 100%; height: 100%; object-fit: cover; transform: rotateY(180deg); }
        #canvas-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: rotateY(180deg); pointer-events: none; }

        .header { margin-top: 50px; text-align: center; z-index: 3; }
        #counter { font-size: 140px; font-weight: 900; margin: 0; color: var(--success); text-shadow: 0 0 25px var(--success); line-height: 1; }
        
        .panel { background: rgba(28, 28, 30, 0.85); width: 90%; padding: 20px; border-radius: 24px; box-sizing: border-box; z-index: 3; border: 1px solid #333; backdrop-filter: blur(15px); margin-top: 10px; }
        .setting-item { margin-bottom: 15px; }
        .setting-label { display: flex; justify-content: space-between; margin-bottom: 8px; color: var(--neon); font-size: 14px; font-weight: 500; }
        
        .switch-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        input[type="checkbox"] { width: 50px; height: 28px; appearance: none; background: #333; border-radius: 20px; position: relative; transition: .3s; outline: none; }
        input[type="checkbox"]:checked { background: var(--primary); }
        input[type="checkbox"]:before { content: ''; position: absolute; width: 24px; height: 24px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: .3s; }
        input[type="checkbox"]:checked:before { left: 24px; }

        input[type=range] { width: 100%; height: 6px; background: #444; border-radius: 5px; appearance: none; outline: none; }
        input[type=range]::-webkit-slider-thumb { appearance: none; width: 24px; height: 24px; background: #fff; border-radius: 50%; box-shadow: 0 0 10px var(--neon); }

        #log { font-size: 13px; color: #888; height: 24px; text-align: center; margin-top: 10px; font-weight: 500; }

        .controls { margin-top: auto; margin-bottom: 40px; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 12px; z-index: 3; }
        button { width: 88%; height: 58px; border-radius: 18px; border: none; font-size: 18px; font-weight: 700; cursor: pointer; }
        #startBtn { background: var(--primary); color: white; box-shadow: 0 0 20px rgba(0, 122, 255, 0.4); }
        #cameraBtn { background: #2c2c2e; color: var(--neon); border: 1px solid var(--neon); display: none; margin-top: -5px; }
        .secondary-btns { display: flex; width: 88%; gap: 10px; }
        .secondary-btns button { font-size: 14px; height: 48px; background: #1c1c1e; color: #999; border: 1px solid #333; }
    </style>
</head>
<body>

    <canvas id="visualizer"></canvas>

    <div id="video-container">
        <video id="webcam" autoplay playsinline muted></video>
        <canvas id="canvas-overlay"></canvas>
    </div>

    <div class="header">
        <div id="counter">0</div>
        <div id="log">系统就绪 // 等待音频上行</div>
    </div>

    <div class="panel">
        <div class="switch-row">
            <span> 视觉校验 (进阶模式)</span>
            <input type="checkbox" id="visionToggle">
        </div>
        
        <div class="setting-item">
            <div class="setting-label">
                <span>触发灵敏度</span>
                <span id="threshVal">0.35</span>
            </div>
            <input type="range" id="threshSlider" min="0.05" max="0.8" step="0.01" value="0.35">
        </div>
    </div>

    <div class="controls">
        <button id="cameraBtn">点击激活摄像头</button>
        <button id="startBtn">启动音频监测</button>
        <div class="secondary-btns">
            <button onclick="resetCount()">计数归零</button>
            <button onclick="window.location.reload()">刷新重置</button>
        </div>
    </div>

    <script type="module">
        let count = 0, isRunning = false, lastEventTime = 0, isWaitingForDrop = false;
        let audioCtx, analyser, dataArray, highPassFilter, wakeLock = null;
        let poseLandmarker, isVisionActive = false;
        
        const vision = window.tasksVision;
        const webcam = document.getElementById("webcam");
        const canvasElement = document.getElementById("canvas-overlay");
        const canvasCtx = canvasElement.getContext("2d");
        const CONFIG = { dropWindow: 650, minFreq: 3000 };

        // 1. 动态频谱渲染
        function drawVisualizer() {
            if (!analyser) return;
            const canvas = document.getElementById('visualizer');
            const ctx = canvas.getContext('2d');
            const w = canvas.width = window.innerWidth;
            const h = canvas.height = 160;
            
            analyser.getFloatTimeDomainData(dataArray);
            ctx.clearRect(0, 0, w, h);
            ctx.beginPath();
            ctx.lineWidth = 2.5;
            ctx.strokeStyle = isVisionActive ? '#00f2ff' : '#00ff41';
            
            for(let i=0; i<dataArray.length; i++) {
                const x = (i / dataArray.length) * w;
                const y = (dataArray[i] * h * 1.8) + h/2;
                if(i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            }
            ctx.stroke();
            requestAnimationFrame(drawVisualizer);
        }

        // 2. 音频启动逻辑
        document.getElementById('startBtn').onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioCtx.createMediaStreamSource(stream);

                highPassFilter = audioCtx.createBiquadFilter();
                highPassFilter.type = "highpass";
                highPassFilter.frequency.value = CONFIG.minFreq;

                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 512;
                source.connect(highPassFilter);
                highPassFilter.connect(analyser);
                dataArray = new Float32Array(analyser.fftSize);

                isRunning = true;
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('log').innerText = "音频链路已建立 // 监听中";
                
                // 激活屏幕常亮
                if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen');
                
                requestAnimationFrame(drawVisualizer);
                requestAnimationFrame(audioUpdate);
            } catch (err) {
                alert("权限错误：请确保使用 HTTPS 并允许麦克风访问");
            }
        };

        // 3. 视觉权限唤醒 (针对 Safari 优化)
        document.getElementById('visionToggle').onchange = (e) => {
            if (e.target.checked) {
                document.getElementById('cameraBtn').style.display = 'block';
                document.getElementById('log').innerText = "等待摄像头授权...";
            } else {
                document.getElementById('cameraBtn').style.display = 'none';
                document.getElementById('video-container').style.height = "0";
                isVisionActive = false;
            }
        };

        document.getElementById('cameraBtn').onclick = async () => {
            try {
                document.getElementById('log').innerText = "正在初始化模型...";
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                webcam.srcObject = stream;
                document.getElementById('video-container').style.height = "30vh";
                
                if (!poseLandmarker) {
                    const filesetResolver = await vision.FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
                    poseLandmarker = await vision.PoseLandmarker.createFromOptions(filesetResolver, {
                        baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task`, delegate: "GPU" },
                        runningMode: "VIDEO", numPoses: 1
                    });
                }
                isVisionActive = true;
                document.getElementById('cameraBtn').style.display = 'none';
                document.getElementById('log').innerText = "双重判定模式已激活";
            } catch (err) {
                alert("摄像头启动失败：请确保在 Safari 设置中允许相机权限");
            }
        };

        // 4. 核心逻辑循环
        function audioUpdate() {
            if (!isRunning) return;
            analyser.getFloatTimeDomainData(dataArray);
            let maxAmp = 0;
            for (let i = 0; i < dataArray.length; i++) maxAmp = Math.max(maxAmp, Math.abs(dataArray[i]));

            const threshold = parseFloat(document.getElementById('threshSlider').value);
            const now = Date.now();

            if (maxAmp > threshold && (now - lastEventTime > 50)) {
                let visualPass = true;
                if (isVisionActive && poseLandmarker) {
                    const res = poseLandmarker.detectForVideo(webcam, performance.now());
                    if (res.landmarks.length > 0) {
                        const lm = res.landmarks[0];
                        // 动作判据：双手间距必须在接球范围内
                        const dist = Math.sqrt(Math.pow(lm[15].x - lm[16].x, 2) + Math.pow(lm[15].y - lm[16].y, 2));
                        if (dist > 0.35) visualPass = false; 
                    }
                }
                if (visualPass) handleImpact(now);
            }
            requestAnimationFrame(audioUpdate);
        }

        function handleImpact(now) {
            if (!isWaitingForDrop) {
                count++;
                isWaitingForDrop = true;
                lastEventTime = now;
                updateUI();
                document.getElementById('log').innerText = "检测到接球动作";
                if (navigator.vibrate) navigator.vibrate(60); // 触感反馈
                setTimeout(() => { isWaitingForDrop = false; }, CONFIG.dropWindow);
            } else if (now - lastEventTime < CONFIG.dropWindow) {
                count = Math.max(0, count - 1);
                isWaitingForDrop = false;
                updateUI();
                document.getElementById('log').innerText = "掉球：计数回扣";
                lastEventTime = now;
            }
        }

        window.resetCount = () => { count = 0; updateUI(); document.getElementById('log').innerText = "已清零"; };
        function updateUI() { document.getElementById('counter').innerText = count; }
        document.getElementById('threshSlider').oninput = (e) => { document.getElementById('threshVal').innerText = e.target.value; };
    </script>
</body>
</html>


