<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>接球计数器 AR Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.js" crossorigin="anonymous"></script>
    <style>
        :root { --primary: #007aff; --success: #00ff41; --neon: #00f2ff; }
        body { margin: 0; background: #000; color: #fff; font-family: -apple-system, sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; }
        
        /* 沉浸式全屏背景 */
        #video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; display: none; background: #000; }
        #webcam { width: 100%; height: 100%; object-fit: cover; transform: rotateY(180deg); }
        #canvas-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: rotateY(180deg); pointer-events: none; }

        /* 全息频谱 */
        #visualizer { position: absolute; top: 0; width: 100%; height: 180px; z-index: 10; pointer-events: none; mix-blend-mode: screen; opacity: 0.7; }

        .status-bar { display: flex; gap: 8px; position: absolute; top: calc(env(safe-area-inset-top) + 15px); z-index: 15; }
        .indicator { padding: 4px 10px; border-radius: 15px; font-size: 10px; background: rgba(0,0,0,0.6); color: #666; border: 1px solid #333; backdrop-filter: blur(5px); }
        .ind-active { border-color: var(--neon); color: var(--neon); box-shadow: 0 0 5px var(--neon); }

        .header { margin-top: auto; margin-bottom: 20px; text-align: center; z-index: 15; }
        #counter { font-size: 150px; font-weight: 900; color: var(--success); text-shadow: 0 0 30px var(--success); line-height: 1; margin: 0; }
        #log { font-size: 14px; color: #fff; height: 20px; text-shadow: 0 1px 3px rgba(0,0,0,0.8); margin-top: 10px; }
        
        .panel { background: rgba(10, 10, 12, 0.6); width: 90%; padding: 20px; border-radius: 24px; box-sizing: border-box; z-index: 15; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); margin-bottom: 15px; }
        .switch-row { display: flex; justify-content: space-between; align-items: center; }
        
        input[type="checkbox"] { width: 50px; height: 26px; appearance: none; background: rgba(255,255,255,0.1); border-radius: 20px; position: relative; border: 1px solid rgba(255,255,255,0.2); }
        input[type="checkbox"]:checked { background: var(--primary); }
        input[type="checkbox"]:before { content: ''; position: absolute; width: 22px; height: 22px; background: white; border-radius: 50%; top: 1px; left: 1px; transition: .3s; }
        input[type="checkbox"]:checked:before { left: 25px; }

        .controls { margin-bottom: calc(env(safe-area-inset-bottom) + 20px); width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; z-index: 15; }
        button { width: 90%; height: 55px; border-radius: 16px; border: none; font-size: 17px; font-weight: 700; transition: 0.2s; }
        #startBtn { background: var(--primary); color: white; }
        #cameraBtn { background: rgba(0,0,0,0.8); color: var(--neon); border: 2px solid var(--neon); display: none; }
    </style>
</head>
<body>

    <div id="video-container">
        <video id="webcam" autoplay playsinline muted></video>
        <canvas id="canvas-overlay"></canvas>
    </div>

    <canvas id="visualizer"></canvas>

    <div class="status-bar">
        <div id="ind-audio" class="indicator">声音: 待机</div>
        <div id="ind-vision" class="indicator">AR: 禁用</div>
        <div id="ind-ai" class="indicator">AI: 待命</div>
    </div>

    <div class="header">
        <div id="counter">0</div>
        <div id="log">准备就绪 // 等待音频上行</div>
    </div>

    <div class="panel">
        <div class="switch-row">
            <span>开启全屏 AR 视觉背景</span>
            <input type="checkbox" id="visionToggle">
        </div>
        <input type="range" id="threshSlider" style="width:100%; margin-top:20px;" min="0.05" max="0.8" step="0.01" value="0.35">
    </div>

    <div class="controls">
        <button id="cameraBtn">开启背景视频</button>
        <button id="startBtn">启动音频监测</button>
        <button style="background:none; color:#555; height:30px; font-size:12px;" onclick="location.reload()">强制刷新</button>
    </div>

<script type="module">
    let count = 0, isRunning = false, lastEventTime = 0, audioCtx, analyser, dataArray, poseLandmarker;
    let isVisionActive = false, isAIReady = false, streamActive = false;
    
    const vision = window.tasksVision;
    const webcam = document.getElementById("webcam");

    // 1. 频谱绘制
    function drawVisualizer() {
        if (!analyser) return;
        const canvas = document.getElementById('visualizer'), ctx = canvas.getContext('2d');
        const w = canvas.width = window.innerWidth, h = canvas.height = 180;
        analyser.getFloatTimeDomainData(dataArray);
        ctx.clearRect(0,0,w,h);
        ctx.beginPath(); ctx.lineWidth = 2.5;
        ctx.strokeStyle = isVisionActive ? '#00f2ff' : '#00ff41';
        for(let i=0; i<dataArray.length; i++) {
            const x = (i/dataArray.length)*w, y = (dataArray[i]*h*1.8)+h/2;
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.stroke();
        requestAnimationFrame(drawVisualizer);
    }

    // 2. 音频启动
    document.getElementById('startBtn').onclick = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioCtx.createMediaStreamSource(stream);
            analyser = audioCtx.createAnalyser(); analyser.fftSize = 512;
            source.connect(analyser); dataArray = new Float32Array(analyser.fftSize);

            isRunning = true;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('ind-audio').classList.add('ind-active');
            document.getElementById('log').innerText = "音频已锁定，可开启 AR 背景";
            requestAnimationFrame(drawVisualizer);
            requestAnimationFrame(audioLoop);
        } catch (err) { alert("麦克风启动失败，请检查 HTTPS 权限"); }
    };

    // 3. 视觉权限修复：分步解耦
    document.getElementById('visionToggle').onchange = (e) => {
        if (e.target.checked) {
            document.getElementById('cameraBtn').style.display = 'block';
            document.getElementById('log').innerText = "请点击上方按钮开启视频";
        } else {
            document.getElementById('cameraBtn').style.display = 'none';
            document.getElementById('video-container').style.display = "none";
            isVisionActive = false;
        }
    };

    document.getElementById('cameraBtn').onclick = async () => {
        try {
            // A. 第一步：仅启动视频流，不加载 AI
            if (!streamActive) {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                webcam.srcObject = stream;
                streamActive = true;
            }
            
            document.getElementById('video-container').style.display = "block";
            document.getElementById('ind-vision').classList.add('ind-active');
            document.getElementById('cameraBtn').innerText = "正在激活 AI 引擎...";
            isVisionActive = true;

            // B. 第二步：异步静默加载 AI
            if (!isAIReady) {
                const FilesetResolver = await vision.FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
                poseLandmarker = await vision.PoseLandmarker.createFromOptions(FilesetResolver, {
                    baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task`, delegate: "GPU" },
                    runningMode: "VIDEO", numPoses: 1
                });
                isAIReady = true;
                document.getElementById('ind-ai').classList.add('ind-active');
                document.getElementById('log').innerText = "AR 画面与 AI 引擎已同步";
            }
            document.getElementById('cameraBtn').style.display = 'none';
        } catch (err) { alert("摄像头启动失败：请检查 Safari 隐私设置"); }
    };

    // 4. 判定循环
    function audioLoop() {
        if (!isRunning) return;
        analyser.getFloatTimeDomainData(dataArray);
        let maxAmp = 0;
        for (let i = 0; i < dataArray.length; i++) maxAmp = Math.max(maxAmp, Math.abs(dataArray[i]));
        const threshold = parseFloat(document.getElementById('threshSlider').value);
        const now = Date.now();

        if (maxAmp > threshold && (now - lastEventTime > 750)) {
            let pass = true;
            // 只有视频在运行且 AI 就绪时才进行姿态校验
            if (isVisionActive && isAIReady && poseLandmarker) {
                const res = poseLandmarker.detectForVideo(webcam, performance.now());
                if (res.landmarks.length > 0) {
                    const lm = res.landmarks[0];
                    const dist = Math.sqrt(Math.pow(lm[15].x - lm[16].x, 2) + Math.pow(lm[15].y - lm[16].y, 2));
                    if (dist > 0.4) pass = false; 
                }
            }
            if (pass) {
                count++; lastEventTime = now;
                document.getElementById('counter').innerText = count;
                if (navigator.vibrate) navigator.vibrate(60);
            }
        }
        requestAnimationFrame(audioLoop);
    }
    window.resetCount = () => { count = 0; document.getElementById('counter').innerText = 0; };
</script>
</body>
</html>
