<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>接球计数器 Pro (视觉+音频版)</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js" crossorigin="anonymous"></script>
    <style>
        :root { --primary: #007aff; --success: #34c759; --danger: #ff3b30; }
        body { margin: 0; background: #000; color: #fff; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* 视频容器：用于人物框锁定 */
        #video-container { position: relative; width: 100%; height: 35vh; background: #111; display: flex; justify-content: center; overflow: hidden; }
        #webcam { height: 100%; transform: rotateY(180deg); }
        #canvas-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: rotateY(180deg); }

        .header { text-align: center; padding: 10px; }
        #counter { font-size: 80px; font-weight: 800; color: var(--success); margin: 0; }
        
        .panel { background: #1c1c1e; width: 90%; margin: 10px auto; padding: 15px; border-radius: 20px; box-sizing: border-box; flex-grow: 1; overflow-y: auto; }
        .setting-item { margin-bottom: 15px; }
        .setting-label { display: flex; justify-content: space-between; font-size: 13px; color: #888; margin-bottom: 5px; }
        
        /* 开关样式 */
        .switch-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        .controls { padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        button { width: 100%; height: 50px; border-radius: 12px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; }
        #startBtn { background: var(--primary); color: white; }
        
        #log { font-size: 12px; color: var(--success); min-height: 20px; text-align: center; margin-top: 5px; }
        .roi-status { font-size: 10px; color: #ff9500; }
    </style>
</head>
<body>

    <div id="video-container">
        <video id="webcam" autoplay playsinline></video>
        <canvas id="canvas-overlay"></canvas>
    </div>

    <div class="header">
        <div id="counter">0</div>
        <div id="log">等待启动...</div>
    </div>

    <div class="panel">
        <div class="switch-row">
            <span>视觉辅助 (双重判据)</span>
            <input type="checkbox" id="visionToggle" checked>
        </div>
        <div class="switch-row">
            <span>人物框锁定 (ROI)</span>
            <input type="checkbox" id="roiToggle" checked>
        </div>
        <div class="switch-row">
            <span>自动截图 (抓拍成功瞬间)</span>
            <input type="checkbox" id="screenshotToggle">
        </div>
        
        <div class="setting-item">
            <div class="setting-label"><span>声音灵敏度</span><span id="threshVal">0.35</span></div>
            <input type="range" id="threshSlider" min="0.05" max="0.8" step="0.01" value="0.35">
        </div>
        
        <div id="capture-preview" style="display: flex; gap: 5px; overflow-x: auto; margin-top: 10px;"></div>
    </div>

    <div class="controls">
        <button id="startBtn">启动 Pro 系统</button>
        <button style="background:#2c2c2e; color:#ccc;" onclick="resetCount()">计数重置</button>
    </div>

<script type="module">
    import { PoseLandmarker, FilesetResolver, DrawingUtils } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js";

    let count = 0;
    let isRunning = false;
    let audioCtx, analyser, dataArray;
    let lastEventTime = 0;
    let poseLandmarker;
    let webcamElement = document.getElementById("webcam");
    let canvasElement = document.getElementById("canvas-overlay");
    let canvasCtx = canvasElement.getContext("2d");
    let drawingUtils = new DrawingUtils(canvasCtx);
    let results = undefined;
    let personInROI = false;

    // --- 1. 初始化姿态模型 ---
    async function initPose() {
        const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/wasm");
        poseLandmarker = await PoseLandmarker.createFromOptions(vision, {
            baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task`, delegate: "GPU" },
            runningMode: "VIDEO",
            numPoses: 1
        });
    }

    // --- 2. 启动逻辑 ---
    document.getElementById('startBtn').onclick = async () => {
        if (!poseLandmarker) await initPose();
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: { facingMode: "user" } });
            webcamElement.srcObject = stream;
            
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioCtx.createMediaStreamSource(stream);
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 512;
            source.connect(analyser);
            dataArray = new Float32Array(analyser.fftSize);

            isRunning = true;
            document.getElementById('startBtn').style.display = 'none';
            predictWebcam();
        } catch (err) {
            alert("需要相机和麦克风权限");
        }
    };

    // --- 3. 核心循环：音视频双重检测 ---
    async function predictWebcam() {
        if (!isRunning) return;

        // A. 视觉处理：人物框锁定
        let startTimeMs = performance.now();
        if (webcamElement.currentTime !== lastEventTime) {
            results = poseLandmarker.detectForVideo(webcamElement, startTimeMs);
            drawROI();
        }

        // B. 音频处理
        analyser.getFloatTimeDomainData(dataArray);
        let maxAmp = 0;
        for (let i = 0; i < dataArray.length; i++) {
            maxAmp = Math.max(maxAmp, Math.abs(dataArray[i]));
        }

        const now = Date.now();
        const threshold = parseFloat(document.getElementById('threshSlider').value);

        // C. 双重判据触发逻辑
        if (maxAmp > threshold && (now - lastEventTime > 800)) {
            let canCount = true;

            // 如果开启 ROI 锁定，必须人在框内才计数
            if (document.getElementById('roiToggle').checked && !personInROI) {
                canCount = false;
                document.getElementById('log').innerText = "不在锁定区域，跳过计数";
            }

            // 如果开启视觉辅助，检查手部位置突变 (加速度判据)
            if (document.getElementById('visionToggle').checked && canCount) {
                if (!checkHandMovement()) {
                    // 如果声音响了但手没动，可能是环境噪音
                    canCount = false; 
                    document.getElementById('log').innerText = "干扰噪音过滤...";
                }
            }

            if (canCount) {
                count++;
                lastEventTime = now;
                updateUI();
                if (document.getElementById('screenshotToggle').checked) takeScreenshot();
            }
        }

        window.requestAnimationFrame(predictWebcam);
    }

    // --- 4. 视觉逻辑子函数 ---
    function drawROI() {
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        personInROI = false;

        if (results && results.landmarks.length > 0) {
            const landmarks = results.landmarks[0];
            // 判断人在不在中央区域 (ROI: 屏幕左右 15% 以外)
            const hip = landmarks[24]; // 右髋
            if (hip.x > 0.15 && hip.x < 0.85) {
                personInROI = true;
                canvasCtx.strokeStyle = "#34c759";
                document.getElementById('log').innerText = "目标锁定";
            } else {
                canvasCtx.strokeStyle = "#ff3b30";
            }
            
            // 绘制骨骼预览
            drawingUtils.drawConnectors(landmarks, PoseLandmarker.POSE_CONNECTIONS);
            drawingUtils.drawLandmarks(landmarks, { radius: 2 });
        }
    }

    // 判断接球视觉特征：双手是否在躯干前方合拢
    function checkHandMovement() {
        if (!results || results.landmarks.length === 0) return true; // 无视觉则信任音频
        const lm = results.landmarks[0];
        const leftWrist = lm[15];
        const rightWrist = lm[16];
        // 视觉判据：双手间距小于一定距离（归一化坐标）
        const dist = Math.sqrt(Math.pow(leftWrist.x - rightWrist.x, 2) + Math.pow(leftWrist.y - rightWrist.y, 2));
        return dist < 0.25; // 接球时双手应靠近
    }

    function takeScreenshot() {
        const preview = document.getElementById('capture-preview');
        const snap = document.createElement('canvas');
        snap.width = webcamElement.videoWidth / 4;
        snap.height = webcamElement.videoHeight / 4;
        snap.getContext('2d').drawImage(webcamElement, 0, 0, snap.width, snap.height);
        const img = new Image();
        img.src = snap.toDataURL();
        img.style.borderRadius = "8px";
        img.style.border = "2px solid #34c759";
        preview.prepend(img);
        if (preview.children.length > 5) preview.lastChild.remove();
    }

    window.resetCount = () => { count = 0; updateUI(); };
    function updateUI() { document.getElementById('counter').innerText = count; }

</script>
</body>
</html>
